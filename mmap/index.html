<!DOCTYPE html>
<html>
<head>
        <title>Marauder's Map</title>
        <link rel="stylesheet" href="mapstyles.css"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body id="mainBody">
        <div id="sideTable"></div>
        <div id="map"></div>
        <script type="text/javascript"
                src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
        <script type="text/javascript">
                var map;
                var login = "ErnieMacmillan";
                var myLoc;
                var position;
                var selfMarker;
                var selfImage = "charImg/ernie.png";
                var studentMarkers = {};
                var studentLoaded = {};
                var characterMarkers = {};
                var characterLoaded = {};
                var initialPan = false;
                var characterImages = {};
                characterImages["carmen"] = "charImg/carmen.png";
                characterImages["waldo"] = "charImg/waldo.png";
                characterImages["batman"] = "charImg/batman.png";
                characterImages["nr"] = "charImg/nr.png";
                characterImages["snape"] = "charImg/snape.png";
                characterImages["hescott"] = "charImg/hescott.png";

                function InitializeMap() {
                        var mapOptions = {
                                center: {lat: 42.35674,
                                         lng: -71.08608},
                                zoom: 14
                        };
                        map = new google.maps.Map(
                                        document.getElementById('map'),
                                        mapOptions);
                }
                google.maps.event.addDomListener(window, 'load', InitializeMap);

                function UpdateRemoteLoc() {
                         function LocationRequestStateChange() {
                                if (locationxhr.status == 200 && 
                                    locationxhr.readyState == 4) {
                                        parsedresponse = JSON.parse(locationxhr.responseText);
                                        parsedresponse.students.forEach(UpdateStudent);
                                        parsedresponse.characters.forEach(UpdateCharacter);
                                        RenderMarkers();
                                }
                        }
                        if (position) {
                                var locationxhr = new XMLHttpRequest();
                                locationxhr.onreadystatechange =
                                        LocationRequestStateChange;
                                locationxhr.open('post',
                                                'http://chickenofthesea.herokuapp.com/sendLocation', true);
                                locationxhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                                var params = "login=" +
                                        login +
                                        "&lat=" +
                                        position.coords.latitude +
                                        "&lng=" +
                                        position.coords.longitude;
                                locationxhr.send(params);
                        }
                }

                function UpdateLocalLocation(newPosition) {
                        position = newPosition;
                        var latlng = new google.maps.LatLng(
                                position.coords.latitude,
                                position.coords.longitude
                                        );
                        if (!initialPan) {
                                map.panTo(latlng);
                                initialPan = true;
                        }
                        if (selfMarker) {
                                selfMarker.setPosition(latlng);
                        } else {
                                selfMarker = new google.maps.Marker({
                                        map: map,
                                        icon: selfImage,
                                        position: latlng,
                                        title: login
                                                });
                        }
                }
 
                function UpdateStudent(student) {
                        var latlng = new google.maps.LatLng(student.lat,
                                                            student.lng);
                        if (studentMarkers[student.login]) {
                                studentMarkers[student.login].setPosition(latlng);
                        } else {
                                var marker = new google.maps.Marker({
                                        map: map,
                                        position: latlng,
                                        title: student.login
                                                });
                                studentMarkers[student.login] = marker;
                        }
                }

                function UpdateCharacter(character) {
                        var latlng = new google.maps.LatLng(character.loc.latitude,
                                                            character.loc.longitude);
                        if (characterMarkers[character.name]) {
                                characterMarkers[character.name].setPosition(latlng);
                        } else {
                                var marker = new google.maps.Marker({
                                        map: map,
                                        icon: characterImages[character.name],
                                        position: latlng,
                                        title: character.name
                                                });               
                                characterMarkers[character.name] = marker;
                        }
                }

                function RenderMarkers() {
                        for (var key in studentMarkers) {
                                if (!studentLoaded[key]) {
                                        studentMarkers[key].setMap(map);
                                        studentLoaded[key] = true;
                                }
                        }
                        for (var key in characterMarkers) {
                                if (!characterLoaded[key]) {
                                        characterMarkers[key].setMap(map);
                                        characterLoaded[key] = true;
                                }
                        }
                }
                navigator.geolocation.watchPosition(UpdateLocalLocation);
                UpdateRemoteLoc();
                setInterval(UpdateRemoteLoc, 1000);
        </script>
</body>
</html>
